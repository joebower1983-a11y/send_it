name: Build & Verify Solana Program

on:
  push:
    branches: [main]
    paths:
      - 'programs/send_it_slim/**'
      - '.github/workflows/verify-program.yml'
  workflow_dispatch:

env:
  PROGRAM_ID: 98Vxqk2dHjLsUb4svNaZWwVZxt9DZZwkRQZZNQmYRm1L

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    container:
      image: backpackapp/build:v0.29.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Program
        run: |
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json --force
          anchor build -p send_it_slim 2>&1 || {
            echo "Anchor build failed, trying cargo build-sbf..."
            cd programs/send_it_slim
            cargo build-sbf 2>&1
          }
          echo "âœ… Build complete"
          find target -name "*.so" -type f

      - name: Compute hashes
        id: hash
        run: |
          SO_FILE=$(find target -name "send_it.so" -type f | head -1)
          if [ -z "$SO_FILE" ]; then
            SO_FILE=$(find target -name "*.so" -type f | head -1)
          fi
          echo "Binary: $SO_FILE"
          HASH=$(sha256sum "$SO_FILE" | awk '{print $1}')
          SIZE=$(stat -c%s "$SO_FILE")
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "path=$SO_FILE" >> $GITHUB_OUTPUT
          
          echo "## ðŸ” Send.it Program Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Program ID** | \`${{ env.PROGRAM_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Hash** | \`${HASH}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | ${SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Compare with on-chain
        run: |
          solana config set --url devnet
          solana program dump ${{ env.PROGRAM_ID }} /tmp/onchain.so --url devnet || true
          if [ -f /tmp/onchain.so ]; then
            ONCHAIN=$(sha256sum /tmp/onchain.so | awk '{print $1}')
            BUILD="${{ steps.hash.outputs.hash }}"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Verification" >> $GITHUB_STEP_SUMMARY
            echo "| Source | Hash |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| On-chain | \`${ONCHAIN}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| This build | \`${BUILD}\` |" >> $GITHUB_STEP_SUMMARY
            if [ "${ONCHAIN}" = "${BUILD}" ]; then
              echo "| **Result** | âœ… **MATCH** |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Result** | âš ï¸ Differs (Playground build env) |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        continue-on-error: true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: send_it_slim-${{ github.sha }}
          path: ${{ steps.hash.outputs.path }}
          retention-days: 90
        continue-on-error: true
