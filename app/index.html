<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send.it ‚Äî Solana Token Launchpad</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--bg2:#151820;--bg3:#1c1f2e;--bg4:#252838;
  --neon:#00e87b;--pink:#ff2d78;--purple:#a855f7;--orange:#ff8800;
  --text:#e8e8f0;--text2:#8888aa;--text3:#555570;
  --glow:0 0 20px rgba(0,232,123,.3);
  --radius:12px;--radius2:8px;
}
html{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);scroll-behavior:smooth}
body{min-height:100vh;overflow-x:hidden;background-image:
  linear-gradient(rgba(0,232,123,.03) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,232,123,.03) 1px,transparent 1px);
  background-size:60px 60px}
a{color:inherit;text-decoration:none}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
input,select,textarea{font-family:inherit;outline:none;border:none;background:var(--bg2);color:var(--text);border-radius:var(--radius2);padding:12px 16px;font-size:14px;width:100%;transition:.2s}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px var(--neon),var(--glow)}
textarea{resize:vertical;min-height:80px}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}

/* ‚îÄ‚îÄ‚îÄ TESTNET BANNER ‚îÄ‚îÄ‚îÄ */
.testnet-banner{position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(90deg,#0f1117,#1a2332,#0f1117);padding:8px 16px;text-align:center;font-weight:800;font-size:13px;letter-spacing:1px;color:var(--neon);text-transform:uppercase;font-family:'JetBrains Mono',monospace;border-bottom:1px solid rgba(0,232,123,.3)}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
#app{display:flex;flex-direction:column;min-height:100vh;padding-top:36px}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header{position:sticky;top:36px;z-index:100;background:rgba(15,17,23,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,232,123,.15);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:10px;font-weight:900;font-size:22px;letter-spacing:-1px}
.logo span{color:var(--neon);text-shadow:0 0 20px rgba(0,232,123,.4)}
.logo-icon{font-size:24px;animation:pulse-glow 2s ease-in-out infinite}
@keyframes pulse-glow{0%,100%{filter:drop-shadow(0 0 6px rgba(0,232,123,.4))}50%{filter:drop-shadow(0 0 14px rgba(0,232,123,.7))}}
.header-right{display:flex;align-items:center;gap:12px}
.sol-balance{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--neon);background:rgba(0,232,123,.08);padding:6px 14px;border-radius:20px;border:1px solid rgba(0,232,123,.15);display:none;align-items:center;gap:6px}
.sol-balance.show{display:flex}
.network-toggle{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;background:var(--bg3);color:var(--text2);border:1px solid rgba(255,255,255,.1);transition:.2s;white-space:nowrap}
.network-toggle:hover{border-color:rgba(0,232,123,.3);color:var(--neon)}
.wallet-btn{padding:10px 20px;border-radius:10px;font-weight:700;font-size:13px;color:#000;background:linear-gradient(135deg,var(--neon),#00c868);transition:.3s}
.wallet-btn:hover{transform:translateY(-1px);box-shadow:var(--glow)}
.wallet-btn.connected{background:var(--bg3);color:var(--neon);border:1px solid rgba(0,232,123,.2)}

/* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
nav{position:sticky;top:96px;z-index:99;background:rgba(15,17,23,.95);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,232,123,.08);display:flex;justify-content:center;gap:4px;padding:8px 16px;overflow-x:auto}
.nav-item{padding:10px 22px;border-radius:10px;font-size:14px;font-weight:600;color:var(--text2);transition:.25s;display:flex;align-items:center;gap:8px;white-space:nowrap}
.nav-item:hover{color:var(--text);background:var(--bg3)}
.nav-item.active{color:var(--neon);background:rgba(0,232,123,.08)}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
main{flex:1;padding:24px;max-width:1200px;margin:0 auto;width:100%}
.page{display:none;animation:fadeUp .3s ease}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card{background:var(--bg2);border:1px solid rgba(255,255,255,.05);border-radius:var(--radius);padding:20px;transition:.25s}
.card:hover{border-color:rgba(0,232,123,.15);box-shadow:0 4px 30px rgba(0,0,0,.3)}

/* ‚îÄ‚îÄ‚îÄ CREATE TOKEN ‚îÄ‚îÄ‚îÄ */
.create-section{max-width:640px;margin:0 auto}
.create-section h1{font-size:32px;font-weight:900;text-align:center;margin-bottom:8px;background:linear-gradient(135deg,var(--neon),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.create-section .subtitle{text-align:center;color:var(--text2);margin-bottom:32px;font-size:15px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-section{background:var(--bg3);border-radius:var(--radius);padding:18px;margin-bottom:20px;border:1px solid rgba(255,255,255,.04)}
.form-section h3{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--pink);margin-bottom:14px}
.upload-area{border:2px dashed var(--bg4);border-radius:var(--radius);padding:32px;text-align:center;cursor:pointer;transition:.2s;color:var(--text2)}
.upload-area:hover{border-color:var(--neon);background:rgba(0,232,123,.03)}
.fee-display{font-family:'JetBrains Mono',monospace;color:var(--neon);font-weight:700;font-size:14px}
.launch-btn{width:100%;padding:18px;border-radius:var(--radius);font-size:18px;font-weight:900;color:#000;background:linear-gradient(135deg,var(--neon),#00c868);text-transform:uppercase;letter-spacing:2px;transition:.3s;margin-top:8px}
.launch-btn:hover{transform:translateY(-2px);box-shadow:0 8px 40px rgba(0,232,123,.4)}
.launch-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

/* ‚îÄ‚îÄ‚îÄ TOKEN GRID ‚îÄ‚îÄ‚îÄ */
.explore-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:16px;flex-wrap:wrap}
.explore-header h2{font-size:24px;font-weight:900}
.search-box{max-width:300px;position:relative}
.search-box input{padding-left:36px}
.search-box i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3)}
.token-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.token-card{cursor:pointer;position:relative;overflow:hidden}
.token-card:hover{transform:translateY(-2px);border-color:rgba(0,232,123,.3)}
.token-head{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.token-img{width:48px;height:48px;border-radius:12px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden}
.token-img img{width:100%;height:100%;object-fit:cover}
.token-name{font-weight:800;font-size:16px}
.token-sym{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--neon)}
.token-time{font-size:11px;color:var(--text3)}
.token-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.token-stats .stat{text-align:center}
.token-stats .label{font-size:10px;text-transform:uppercase;color:var(--text3);letter-spacing:.5px}
.token-stats .value{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--text)}
.migration-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-bottom:6px}
.migration-bar .fill{height:100%;background:linear-gradient(90deg,var(--neon),var(--purple));border-radius:2px;transition:width .5s}
.migration-label{display:flex;justify-content:space-between;font-size:11px;color:var(--text3)}
.creator-addr{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);margin-top:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:6px}
.badge-live{background:rgba(0,232,123,.15);color:var(--neon)}
.badge-migrated{background:rgba(168,85,247,.15);color:var(--purple)}

/* ‚îÄ‚îÄ‚îÄ TOKEN DETAIL ‚îÄ‚îÄ‚îÄ */
.detail-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);overflow-y:auto;padding:24px}
.detail-overlay.show{display:flex;justify-content:center;align-items:flex-start;padding-top:80px}
.detail-panel{background:var(--bg2);border:1px solid rgba(0,232,123,.15);border-radius:16px;max-width:560px;width:100%;padding:28px;position:relative;animation:fadeUp .3s}
.detail-close{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:8px;background:var(--bg3);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:16px}
.detail-close:hover{color:var(--text);background:var(--bg4)}
.detail-header{display:flex;align-items:center;gap:16px;margin-bottom:24px}
.detail-header .token-img{width:64px;height:64px;font-size:32px}
.detail-info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.detail-info-item{background:var(--bg3);border-radius:var(--radius2);padding:12px}
.detail-info-item .label{font-size:10px;text-transform:uppercase;color:var(--text3);letter-spacing:.5px;margin-bottom:4px}
.detail-info-item .value{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.trade-tabs{display:flex;gap:4px;margin-bottom:16px}
.trade-tab{flex:1;padding:10px;border-radius:var(--radius2);font-weight:700;font-size:14px;text-align:center;background:var(--bg3);color:var(--text2);transition:.2s}
.trade-tab.active-buy{background:rgba(0,232,123,.15);color:var(--neon)}
.trade-tab.active-sell{background:rgba(255,45,120,.15);color:var(--pink)}
.trade-input-group{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.trade-input-group input{flex:1}
.trade-input-group .unit{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text2);white-space:nowrap}
.trade-btn{width:100%;padding:14px;border-radius:var(--radius2);font-size:16px;font-weight:800;transition:.3s}
.trade-btn.buy{color:#000;background:linear-gradient(135deg,var(--neon),#00c868)}
.trade-btn.sell{color:#fff;background:linear-gradient(135deg,var(--pink),#d41e5c)}
.trade-btn:hover{transform:translateY(-1px)}
.trade-btn:disabled{opacity:.5;transform:none;cursor:not-allowed}
.quick-amounts{display:flex;gap:6px;margin-bottom:12px}
.quick-amt{padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;background:var(--bg3);color:var(--text2);transition:.2s}
.quick-amt:hover{color:var(--neon);background:var(--bg4)}

/* ‚îÄ‚îÄ‚îÄ PORTFOLIO ‚îÄ‚îÄ‚îÄ */
.portfolio-empty{text-align:center;padding:60px 20px;color:var(--text2)}
.portfolio-empty i{font-size:48px;margin-bottom:16px;color:var(--text3)}
.position-card{display:flex;align-items:center;gap:16px;padding:16px;margin-bottom:12px}
.position-card .token-img{width:40px;height:40px;font-size:20px}

/* ‚îÄ‚îÄ‚îÄ PLATFORM STATS ‚îÄ‚îÄ‚îÄ */
.stats-bar{display:flex;justify-content:center;gap:32px;padding:16px;margin-bottom:24px;flex-wrap:wrap}
.stats-bar .stat-item{text-align:center}
.stats-bar .stat-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:900;color:var(--neon)}
.stats-bar .stat-label{font-size:11px;text-transform:uppercase;color:var(--text3);letter-spacing:.5px;margin-top:2px}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg3);color:var(--neon);padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;border:1px solid rgba(0,232,123,.3);box-shadow:0 8px 30px rgba(0,0,0,.5);z-index:10000;animation:fadeUp .3s}

/* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--bg4);border-top-color:var(--neon);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-grid{text-align:center;padding:40px;color:var(--text2)}

/* ‚îÄ‚îÄ‚îÄ TX RESULT ‚îÄ‚îÄ‚îÄ */
.tx-result{margin-top:16px;padding:14px;border-radius:var(--radius2);background:rgba(0,232,123,.06);border:1px solid rgba(0,232,123,.2);font-size:13px;display:none}
.tx-result.show{display:block;animation:fadeUp .3s}
.tx-result a{color:var(--neon);text-decoration:underline}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:640px){
  .form-row{grid-template-columns:1fr}
  .detail-info-grid{grid-template-columns:1fr}
  .stats-bar{gap:16px}
  .stats-bar .stat-val{font-size:16px}
  .token-grid{grid-template-columns:1fr}
  .explore-header{flex-direction:column;align-items:stretch}
  .search-box{max-width:100%}
  header{padding:0 16px}
  main{padding:16px}
}
</style>
</head>
<body>

<!-- Testnet Banner -->
<div class="testnet-banner" id="testnetBanner">
  <span>‚ö†Ô∏è Devnet ‚Äî Tokens have no real value</span>
</div>

<div id="app">
  <!-- Header -->
  <header>
    <div class="logo">
      <span class="logo-icon">üöÄ</span>
      <span>Send<span style="color:var(--pink)">.it</span></span>
    </div>
    <div class="header-right">
      <button class="network-toggle" id="networkToggle" title="Switch network">
        <span id="networkLabel">üß™ Devnet</span>
      </button>
      <div class="sol-balance" id="solBalance">
        <i class="fa-solid fa-coins"></i>
        <span id="balanceAmt">0.00</span> SOL
      </div>
      <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">
        <i class="fa-solid fa-wallet"></i>&nbsp; Connect Wallet
      </button>
    </div>
  </header>

  <!-- Nav -->
  <nav>
    <button class="nav-item active" data-page="explore"><i class="fa-solid fa-compass"></i> Explore</button>
    <button class="nav-item" data-page="launch"><i class="fa-solid fa-rocket"></i> Launch</button>
    <button class="nav-item" data-page="portfolio"><i class="fa-solid fa-chart-pie"></i> Portfolio</button>
  </nav>

  <!-- Platform Stats -->
  <div class="stats-bar">
    <div class="stat-item"><div class="stat-val" id="statLaunches">-</div><div class="stat-label">Tokens Launched</div></div>
    <div class="stat-item"><div class="stat-val" id="statVolume">-</div><div class="stat-label">Total Volume (SOL)</div></div>
    <div class="stat-item"><div class="stat-val" id="statNetwork">Devnet</div><div class="stat-label">Network</div></div>
  </div>

  <main>
    <!-- ‚ïê‚ïê‚ïê EXPLORE PAGE ‚ïê‚ïê‚ïê -->
    <div class="page active" id="page-explore">
      <div class="explore-header">
        <h2>üî• Live Tokens</h2>
        <div class="search-box">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search tokens..." oninput="filterTokens()">
        </div>
      </div>
      <div id="tokenGrid" class="token-grid">
        <div class="loading-grid"><div class="spinner"></div><p style="margin-top:12px">Connect wallet to load tokens...</p></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LAUNCH PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-launch">
      <div class="create-section">
        <h1>üöÄ Launch a Token</h1>
        <p class="subtitle">Deploy your token to Solana in seconds</p>

        <div class="form-section">
          <h3><i class="fa-solid fa-tag"></i> Token Info</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Token Name</label>
              <input type="text" id="tokenName" placeholder="e.g. DogCoin" maxlength="32">
            </div>
            <div class="form-group">
              <label>Symbol</label>
              <input type="text" id="tokenSymbol" placeholder="e.g. DOG" maxlength="10" style="text-transform:uppercase">
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="tokenDesc" placeholder="What's your token about?" rows="3"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fa-solid fa-image"></i> Token Image</h3>
          <div class="upload-area" id="uploadArea">
            <i class="fa-solid fa-cloud-arrow-up" style="font-size:32px;margin-bottom:8px;display:block"></i>
            <div style="font-weight:600">Drop image here or click to upload</div>
            <div style="font-size:12px;margin-top:4px">PNG, JPG, GIF, WEBP ¬∑ Max 5MB</div>
          </div>
          <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="storachaToggle" checked style="width:auto">
            <label for="storachaToggle" style="font-size:12px;color:var(--text2);cursor:pointer">Store on Filecoin (via Storacha) ‚Äî permanent decentralized storage</label>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fa-solid fa-sliders"></i> Settings</h3>
          <div class="form-group">
            <label>Creator Fee: <span class="fee-display" id="feeDisplay">5%</span></label>
            <input type="range" id="creatorFee" min="0" max="10" step="0.5" value="5" style="padding:0" oninput="document.getElementById('feeDisplay').textContent=this.value+'%'">
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:4px"><span>0%</span><span>10%</span></div>
          </div>
          <div class="form-group">
            <label>Metadata URI (optional ‚Äî auto-generated if using Storacha)</label>
            <input type="text" id="tokenUri" placeholder="https://...">
          </div>
        </div>

        <button class="launch-btn" id="launchBtn" onclick="createToken()">üöÄ Launch Token</button>

        <div class="tx-result" id="createTxResult"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PORTFOLIO PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-portfolio">
      <h2 style="font-size:24px;font-weight:900;margin-bottom:20px">üíº Your Portfolio</h2>
      <div id="portfolioContent">
        <div class="portfolio-empty">
          <i class="fa-solid fa-wallet"></i>
          <p style="font-size:16px;font-weight:600;margin-bottom:8px">Connect your wallet</p>
          <p>Your token positions will appear here</p>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Token Detail Overlay -->
<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<script src="storacha-upload.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ Network Config ‚îÄ‚îÄ‚îÄ
const NETWORKS = {
  devnet: {
    name: 'Devnet',
    rpc: 'https://api.devnet.solana.com',
    programId: 'HTKq18cATdwCZb6XM66Mhn8JWKCFTrZqH6zU1zip88Zx',
    chain: 'solana:devnet',
    solscanCluster: '${net().solscanCluster}',
    label: 'üß™ Devnet',
    bannerColor: 'linear-gradient(90deg,#0f1117,#1a2332,#0f1117)',
    bannerText: '‚ö†Ô∏è Devnet ‚Äî Tokens have no real value',
  },
  mainnet: {
    name: 'Mainnet',
    rpc: 'https://api.mainnet-beta.solana.com',
    programId: null, // SET THIS AFTER MAINNET DEPLOY
    chain: 'solana:mainnet',
    solscanCluster: '',
    label: 'üü¢ Mainnet',
    bannerColor: 'linear-gradient(90deg,#0f1117,#1a1a2e,#0f1117)',
    bannerText: 'üü¢ Mainnet ‚Äî Real tokens, real value',
  },
};

// Read saved network preference, default to devnet
let currentNetwork = localStorage.getItem('sendit_network') || 'devnet';
// Force devnet if mainnet program not deployed yet
if (currentNetwork === 'mainnet' && !NETWORKS.mainnet.programId) currentNetwork = 'devnet';

function net() { return NETWORKS[currentNetwork]; }

const TOKEN_PROGRAM_ID = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
const ATA_PROGRAM_ID = 'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL';
const MPL_TOKEN_METADATA_ID = 'metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s';
const TAPESTRY_KEY = '601a8251-9c95-4456-97af-c1e79b5c0259';
const TAPESTRY_API = 'https://api.usetapestry.dev/api/v1';

const SEEDS = {
  platformConfig: 'platform_config',
  tokenLaunch: 'token_launch',
  solVault: 'sol_vault',
  platformVault: 'platform_vault',
  userPosition: 'user_position',
};

let connection = null;
let walletAdapter = null;
let walletPubkey = null;
let PROGRAM_KEY = null;
let TOKEN_PROGRAM = null;
let ATA_PROGRAM = null;
let MPL_METADATA = null;

let allTokens = []; // cached TokenLaunch data
let selectedImageFile = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  initNetwork();
  initNav();
  initNetworkToggle();
  initImageUpload();
  loadLiveTokens();
  updatePlatformStats();
});

function initNetwork() {
  const { Connection, PublicKey } = solanaWeb3;
  connection = new Connection(net().rpc, 'confirmed');
  PROGRAM_KEY = new PublicKey(net().programId);
  TOKEN_PROGRAM = new PublicKey(TOKEN_PROGRAM_ID);
  ATA_PROGRAM = new PublicKey(ATA_PROGRAM_ID);
  MPL_METADATA = new PublicKey(MPL_TOKEN_METADATA_ID);

  // Update banner
  const banner = document.getElementById('testnetBanner');
  if (banner) {
    banner.style.background = net().bannerColor;
    banner.querySelector('span').textContent = net().bannerText;
    banner.style.color = currentNetwork === 'mainnet' ? '#00e87b' : 'var(--neon)';
  }

  // Update network selector display
  const netLabel = document.getElementById('networkLabel');
  if (netLabel) netLabel.textContent = net().label;

  // Update stats bar
  const statNet = document.getElementById('statNetwork');
  if (statNet) statNet.textContent = net().name;
}

function switchNetwork(network) {
  if (network === currentNetwork) return;
  if (network === 'mainnet' && !NETWORKS.mainnet.programId) {
    toast('Mainnet program not deployed yet ‚Äî coming soon!');
    return;
  }

  // Disconnect wallet on network switch
  if (walletPubkey) {
    try { walletAdapter?.disconnect?.(); } catch(e) {}
    walletPubkey = null;
    walletAdapter = null;
    const btn = document.getElementById('walletBtn');
    btn.innerHTML = '<i class="fa-solid fa-wallet"></i>&nbsp; Connect Wallet';
    btn.classList.remove('connected');
    document.getElementById('solBalance').classList.remove('show');
  }

  currentNetwork = network;
  localStorage.setItem('sendit_network', network);
  allTokens = [];
  initNetwork();
  loadLiveTokens();
  updatePlatformStats();
  toast(`Switched to ${net().name}`);
}

function initNetworkToggle() {
  const toggle = document.getElementById('networkToggle');
  if (!toggle) return;
  toggle.addEventListener('click', () => {
    switchNetwork(currentNetwork === 'devnet' ? 'mainnet' : 'devnet');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initNav() {
  document.querySelectorAll('.nav-item').forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.dataset.page;
      if (!page) return;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + page)?.classList.add('active');
      if (page === 'portfolio') loadPortfolio();
    });
  });
}

function showPage(id) {
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.page === id);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + id)?.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WALLET (Wallet Standard + legacy fallback)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Wallet Standard: detect wallets registered via the standard protocol
// This is the proper way ‚Äî avoids Phantom phishing warnings
const registeredWallets = [];

function getWalletStandardWallets() {
  try {
    const wallets = window.navigator?.wallets;
    if (wallets) {
      const discovered = [];
      wallets.get().forEach(w => {
        if (w.features?.['standard:connect'] && w.chains?.some(c => c.startsWith('solana:'))) {
          discovered.push(w);
        }
      });
      return discovered;
    }
  } catch (e) { console.warn('Wallet Standard discovery failed:', e); }
  return [];
}

// Also listen for wallets registering after page load
try {
  window.navigator?.wallets?.on('register', (wallet) => {
    if (wallet.features?.['standard:connect'] && wallet.chains?.some(c => c.startsWith('solana:'))) {
      registeredWallets.push(wallet);
    }
  });
} catch (e) {}

function detectWallets() {
  const wallets = [];

  // 1. Wallet Standard wallets (preferred ‚Äî no phishing warning)
  const stdWallets = [...getWalletStandardWallets(), ...registeredWallets];
  const seenNames = new Set();
  for (const w of stdWallets) {
    if (seenNames.has(w.name)) continue;
    seenNames.add(w.name);
    wallets.push({
      name: w.name,
      icon: w.icon || 'üí≥',
      isStandard: true,
      standardWallet: w,
    });
  }

  // 2. Legacy injected providers (fallback)
  if (!seenNames.has('Phantom') && window.solana?.isPhantom) {
    wallets.push({ name: 'Phantom', icon: 'https://phantom.app/img/logo.png', isStandard: false, provider: window.solana });
  }
  if (!seenNames.has('Solflare') && window.solflare?.isSolflare) {
    wallets.push({ name: 'Solflare', icon: 'https://solflare.com/favicon.ico', isStandard: false, provider: window.solflare });
  }
  if (!seenNames.has('Backpack') && window.backpack?.isBackpack) {
    wallets.push({ name: 'Backpack', icon: 'üéí', isStandard: false, provider: window.backpack });
  }

  return wallets;
}

async function connectWallet() {
  const btn = document.getElementById('walletBtn');

  // Disconnect
  if (walletPubkey) {
    try {
      if (walletAdapter?.disconnect) await walletAdapter.disconnect();
      if (walletAdapter?.features?.['standard:disconnect']) {
        await walletAdapter.features['standard:disconnect'].disconnect();
      }
    } catch (e) { console.warn('Disconnect error:', e); }
    walletPubkey = null;
    walletAdapter = null;
    btn.innerHTML = '<i class="fa-solid fa-wallet"></i>&nbsp; Connect Wallet';
    btn.classList.remove('connected');
    document.getElementById('solBalance').classList.remove('show');
    toast('Wallet disconnected');
    return;
  }

  // Detect available wallets
  const wallets = detectWallets();

  if (wallets.length === 0) {
    toast('No wallet found ‚Äî install Phantom, Solflare, or Backpack');
    window.open('https://phantom.app/', '_blank');
    return;
  }

  // Pick wallet
  let chosen;
  if (wallets.length === 1) {
    chosen = wallets[0];
  } else {
    chosen = await showWalletPicker(wallets);
    if (!chosen) return;
  }

  try {
    if (chosen.isStandard) {
      // Wallet Standard connect
      const connectFeature = chosen.standardWallet.features['standard:connect'];
      const result = await connectFeature.connect();
      const account = result.accounts[0];
      if (!account) throw new Error('No account returned');

      walletPubkey = new solanaWeb3.PublicKey(account.address);
      // Build an adapter shim for signTransaction
      walletAdapter = buildStandardAdapter(chosen.standardWallet);
    } else {
      // Legacy provider connect
      const resp = await chosen.provider.connect();
      walletAdapter = chosen.provider;
      walletPubkey = resp.publicKey || chosen.provider.publicKey;
    }

    const addr = walletPubkey.toBase58();
    btn.innerHTML = `<i class="fa-solid fa-right-from-bracket"></i>&nbsp; ${addr.slice(0,4)}..${addr.slice(-4)}`;
    btn.classList.add('connected');
    toast(`Connected to ${chosen.name}! ‚úÖ`);

    await updateBalance();
    loadLiveTokens();
  } catch (e) {
    console.error('Wallet connect failed:', e);
    if (e.message?.includes('User rejected')) {
      toast('Connection cancelled');
    } else {
      toast('Connection failed: ' + (e.message || e));
    }
  }
}

// Build a signTransaction shim for Wallet Standard wallets
function buildStandardAdapter(stdWallet) {
  return {
    _std: stdWallet,
    disconnect: async () => {
      const feat = stdWallet.features['standard:disconnect'];
      if (feat) await feat.disconnect();
    },
    signTransaction: async (tx) => {
      const feat = stdWallet.features['solana:signTransaction'];
      if (feat) {
        const serialized = tx.serialize({ requireAllSignatures: false, verifySignatures: false });
        const result = await feat.signTransaction({
          transaction: serialized,
          chain: net().chain,
        });
        return solanaWeb3.Transaction.from(result.signedTransaction);
      }
      // Fallback: signAndSendTransaction
      throw new Error('Wallet does not support signTransaction');
    },
    signAndSendTransaction: async (tx) => {
      const feat = stdWallet.features['solana:signAndSendTransaction'];
      if (feat) {
        const serialized = tx.serialize({ requireAllSignatures: false, verifySignatures: false });
        const result = await feat.signAndSendTransaction({
          transaction: serialized,
          chain: net().chain,
        });
        return { signature: result.signature };
      }
      throw new Error('Wallet does not support signAndSendTransaction');
    }
  };
}

function showWalletPicker(wallets) {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center';
    overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); resolve(null); } };

    const panel = document.createElement('div');
    panel.style.cssText = 'background:var(--bg2);border:1px solid rgba(0,232,123,.15);border-radius:16px;padding:24px;max-width:340px;width:100%;animation:fadeUp .3s';
    panel.innerHTML = `
      <h3 style="margin-bottom:4px;font-size:18px;font-weight:800">Connect Wallet</h3>
      <p style="font-size:12px;color:var(--text3);margin-bottom:16px">Choose your Solana wallet</p>
    `;

    wallets.forEach(w => {
      const btn = document.createElement('button');
      btn.style.cssText = 'display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;border-radius:10px;background:var(--bg3);color:var(--text);font-size:15px;font-weight:600;margin-bottom:8px;transition:.2s;border:1px solid transparent';

      const iconHtml = (w.icon && w.icon.startsWith('http'))
        ? `<img src="${w.icon}" style="width:28px;height:28px;border-radius:6px" onerror="this.textContent='üí≥'">`
        : `<span style="font-size:24px">${w.icon || 'üí≥'}</span>`;
      btn.innerHTML = `${iconHtml} <span>${w.name}</span>`;

      btn.onmouseenter = () => { btn.style.borderColor = 'rgba(0,232,123,.3)'; btn.style.background = 'var(--bg4)'; };
      btn.onmouseleave = () => { btn.style.borderColor = 'transparent'; btn.style.background = 'var(--bg3)'; };
      btn.onclick = () => { overlay.remove(); resolve(w); };
      panel.appendChild(btn);
    });

    // "Get a wallet" link
    const getWallet = document.createElement('a');
    getWallet.href = 'https://phantom.app/';
    getWallet.target = '_blank';
    getWallet.style.cssText = 'display:block;text-align:center;font-size:12px;color:var(--text3);margin-top:12px;text-decoration:underline';
    getWallet.textContent = "Don't have a wallet? Get Phantom ‚Üí";
    panel.appendChild(getWallet);

    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    // Escape to close
    const handler = (e) => { if (e.key === 'Escape') { overlay.remove(); resolve(null); document.removeEventListener('keydown', handler); } };
    document.addEventListener('keydown', handler);
  });
}

// Universal sign + send helper (works with both Standard and legacy wallets)
async function signAndSend(tx) {
  // Try legacy signTransaction first (most common path)
  if (walletAdapter.signTransaction) {
    try {
      const signed = await walletAdapter.signTransaction(tx);
      const sig = await connection.sendRawTransaction(signed.serialize());
      return sig;
    } catch (e) {
      // If signTransaction fails on standard wallet, try signAndSendTransaction
      if (walletAdapter.signAndSendTransaction && e.message?.includes('does not support')) {
        const result = await walletAdapter.signAndSendTransaction(tx);
        return result.signature;
      }
      throw e;
    }
  }
  // Fallback: signAndSendTransaction
  if (walletAdapter.signAndSendTransaction) {
    const result = await walletAdapter.signAndSendTransaction(tx);
    return result.signature;
  }
  throw new Error('Wallet does not support transaction signing');
}

async function updateBalance() {
  if (!walletPubkey) return;
  try {
    const bal = await connection.getBalance(walletPubkey);
    document.getElementById('balanceAmt').textContent = (bal / 1e9).toFixed(4);
    document.getElementById('solBalance').classList.add('show');
  } catch (e) {
    console.error('Balance fetch failed:', e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getDiscriminator(name) {
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode('global:' + name));
  return new Uint8Array(hash).slice(0, 8);
}

function encodeString(s) {
  const encoded = new TextEncoder().encode(s);
  const buf = new Uint8Array(4 + encoded.length);
  new DataView(buf.buffer).setUint32(0, encoded.length, true);
  buf.set(encoded, 4);
  return buf;
}

function concat(...arrays) {
  const total = arrays.reduce((s, a) => s + a.length, 0);
  const result = new Uint8Array(total);
  let off = 0;
  for (const a of arrays) { result.set(a, off); off += a.length; }
  return result;
}

function findPDA(seeds) {
  return solanaWeb3.PublicKey.findProgramAddressSync(
    seeds.map(s => typeof s === 'string' ? new TextEncoder().encode(s) : (s instanceof solanaWeb3.PublicKey ? s.toBuffer() : s)),
    PROGRAM_KEY
  );
}

function getATA(mint, owner) {
  const [ata] = solanaWeb3.PublicKey.findProgramAddressSync(
    [owner.toBuffer(), TOKEN_PROGRAM.toBuffer(), mint.toBuffer()],
    ATA_PROGRAM
  );
  return ata;
}

function timeAgo(ts) {
  const s = Math.floor(Date.now() / 1000 - ts);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

function fmtSol(lamports) {
  return (Number(lamports) / 1e9).toFixed(4);
}

function fmtTokens(raw) {
  return (Number(raw) / 1e6).toLocaleString(undefined, { maximumFractionDigits: 0 });
}

function fmtNum(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DECODE TOKEN LAUNCH ACCOUNTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function decodeTokenLaunch(data, pubkey) {
  try {
    const view = new DataView(data.buffer, data.byteOffset);
    let off = 8; // skip discriminator

    const creator = solanaWeb3.PublicKey.decode(data.slice(off, off + 32)); off += 32; // creator pubkey (raw bytes, not base58)
    const mint = solanaWeb3.PublicKey.decode(data.slice(off, off + 32)); off += 32;

    // Borsh string: u32 len + utf8
    const nameLen = view.getUint32(off, true); off += 4;
    const name = new TextDecoder().decode(data.slice(off, off + nameLen)); off += nameLen;

    const symLen = view.getUint32(off, true); off += 4;
    const symbol = new TextDecoder().decode(data.slice(off, off + symLen)); off += symLen;

    const uriLen = view.getUint32(off, true); off += 4;
    const uri = new TextDecoder().decode(data.slice(off, off + uriLen)); off += uriLen;

    const creatorFeeBps = view.getUint16(off, true); off += 2;
    const totalSupply = view.getBigUint64(off, true); off += 8;
    const tokensSold = view.getBigUint64(off, true); off += 8;
    const totalStaked = view.getBigUint64(off, true); off += 8;
    const reserveSol = view.getBigUint64(off, true); off += 8;
    const createdAt = Number(view.getBigInt64(off, true)); off += 8;
    const migrated = data[off] === 1; off += 1;
    const totalVolumeSol = view.getBigUint64(off, true); off += 8;

    // Price estimate from bonding curve
    const soldNum = Number(tokensSold);
    const reserveNum = Number(reserveSol);
    const price = soldNum > 0 ? reserveNum / soldNum : 0;

    // Migration % (tokens sold vs total supply)
    const supplyNum = Number(totalSupply);
    const migrationPct = supplyNum > 0 ? Math.min(100, (soldNum / supplyNum) * 100) : 0;

    return {
      pubkey: pubkey.toBase58(),
      creator: creator.toBase58(),
      mint: mint.toBase58(),
      name, symbol, uri,
      creatorFeeBps,
      totalSupply: supplyNum,
      tokensSold: soldNum,
      totalStaked: Number(totalStaked),
      reserveSol: reserveNum,
      createdAt,
      migrated,
      totalVolumeSol: Number(totalVolumeSol),
      price,
      migrationPct,
    };
  } catch (e) {
    console.warn('Failed to decode TokenLaunch:', e);
    return null;
  }
}

// PublicKey.decode helper ‚Äî Solana web3 PublicKey from raw bytes
if (!solanaWeb3.PublicKey.decode) {
  solanaWeb3.PublicKey.decode = function(buf) {
    return new solanaWeb3.PublicKey(buf);
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD LIVE TOKENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadLiveTokens() {
  const grid = document.getElementById('tokenGrid');
  grid.innerHTML = `<div class="loading-grid"><div class="spinner"></div><p style="margin-top:12px">Loading tokens from ${net().name}...</p></div>`;

  try {
    // Fetch all program accounts ‚Äî TokenLaunch accounts are the biggest ones
    const accounts = await connection.getProgramAccounts(PROGRAM_KEY, {
      commitment: 'confirmed',
    });

    // Filter for TokenLaunch accounts (they have the token_launch discriminator)
    const tokenLaunchDisc = await getDiscriminator('token_launch');
    // Actually Anchor uses account name: "TokenLaunch" -> sha256("account:TokenLaunch")[0..8]
    const accountDisc = await crypto.subtle.digest('SHA-256', new TextEncoder().encode('account:TokenLaunch'));
    const disc = new Uint8Array(accountDisc).slice(0, 8);

    allTokens = [];
    for (const acc of accounts) {
      const data = acc.account.data;
      if (data.length < 80) continue; // too small to be a TokenLaunch

      // Check discriminator
      const accDisc = data.slice(0, 8);
      let match = true;
      for (let i = 0; i < 8; i++) {
        if (accDisc[i] !== disc[i]) { match = false; break; }
      }
      if (!match) continue;

      const decoded = decodeTokenLaunch(data, acc.pubkey);
      if (decoded) allTokens.push(decoded);
    }

    // Sort by newest first
    allTokens.sort((a, b) => b.createdAt - a.createdAt);
    renderTokenGrid(allTokens);
    updatePlatformStats();
  } catch (e) {
    console.error('Failed to load tokens:', e);
    grid.innerHTML = `
      <div class="loading-grid">
        <i class="fa-solid fa-triangle-exclamation" style="font-size:32px;color:var(--pink);margin-bottom:12px"></i>
        <p>Failed to load tokens</p>
        <p style="font-size:12px;color:var(--text3);margin-top:4px">${e.message}</p>
        <button onclick="loadLiveTokens()" style="margin-top:12px;padding:8px 20px;border-radius:8px;background:var(--bg3);color:var(--neon);font-weight:600">Retry</button>
      </div>
    `;
  }
}

function renderTokenGrid(tokens) {
  const grid = document.getElementById('tokenGrid');

  if (tokens.length === 0) {
    grid.innerHTML = `
      <div class="loading-grid" style="grid-column:1/-1">
        <i class="fa-solid fa-rocket" style="font-size:40px;color:var(--text3);margin-bottom:12px"></i>
        <p style="font-weight:600">No tokens launched yet</p>
        <p style="font-size:13px;color:var(--text3);margin-top:4px">Be the first ‚Äî click Launch above!</p>
      </div>
    `;
    return;
  }

  grid.innerHTML = tokens.map(t => `
    <div class="card token-card" onclick="openDetail('${t.mint}')">
      <div class="token-head">
        <div class="token-img">${t.uri && t.uri.startsWith('http') ? `<img src="${t.uri}" onerror="this.parentElement.innerHTML='ü™ô'">` : 'ü™ô'}</div>
        <div>
          <div class="token-name">${escHtml(t.name)} <span class="badge ${t.migrated ? 'badge-migrated' : 'badge-live'}">${t.migrated ? 'AMM' : 'LIVE'}</span></div>
          <div class="token-sym">$${escHtml(t.symbol)}</div>
          <div class="token-time">${timeAgo(t.createdAt)}</div>
        </div>
      </div>
      <div class="token-stats">
        <div class="stat">
          <div class="label">Reserve</div>
          <div class="value" style="color:var(--neon)">${fmtSol(t.reserveSol)} SOL</div>
        </div>
        <div class="stat">
          <div class="label">Sold</div>
          <div class="value">${fmtNum(t.tokensSold / 1e6)}</div>
        </div>
        <div class="stat">
          <div class="label">Volume</div>
          <div class="value">${fmtSol(t.totalVolumeSol)} SOL</div>
        </div>
      </div>
      <div class="migration-bar"><div class="fill" style="width:${t.migrationPct.toFixed(1)}%"></div></div>
      <div class="migration-label"><span>Bonding Curve</span><span style="color:${t.migrationPct > 80 ? 'var(--neon)' : 'var(--text2)'}">${t.migrationPct.toFixed(1)}%</span></div>
      <div class="creator-addr">by ${t.creator.slice(0,4)}..${t.creator.slice(-4)}</div>
    </div>
  `).join('');
}

function filterTokens() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allTokens.filter(t =>
    t.name.toLowerCase().includes(q) ||
    t.symbol.toLowerCase().includes(q) ||
    t.mint.toLowerCase().includes(q)
  );
  renderTokenGrid(filtered);
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLATFORM STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updatePlatformStats() {
  document.getElementById('statLaunches').textContent = allTokens.length || '-';
  const totalVol = allTokens.reduce((s, t) => s + t.totalVolumeSol, 0);
  document.getElementById('statVolume').textContent = totalVol > 0 ? fmtSol(totalVol) : '-';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOKEN DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentDetailToken = null;
let tradeMode = 'buy';

function openDetail(mintStr) {
  const t = allTokens.find(tk => tk.mint === mintStr);
  if (!t) { toast('Token not found'); return; }
  currentDetailToken = t;
  tradeMode = 'buy';

  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <button class="detail-close" onclick="closeDetail()"><i class="fa-solid fa-xmark"></i></button>

    <div class="detail-header">
      <div class="token-img">${t.uri && t.uri.startsWith('http') ? `<img src="${t.uri}" onerror="this.parentElement.innerHTML='ü™ô'">` : 'ü™ô'}</div>
      <div>
        <div style="font-size:24px;font-weight:900">${escHtml(t.name)}</div>
        <div style="font-family:'JetBrains Mono',monospace;color:var(--neon);font-size:14px">$${escHtml(t.symbol)}</div>
      </div>
    </div>

    <div class="detail-info-grid">
      <div class="detail-info-item">
        <div class="label">Reserve</div>
        <div class="value" style="color:var(--neon)">${fmtSol(t.reserveSol)} SOL</div>
      </div>
      <div class="detail-info-item">
        <div class="label">Tokens Sold</div>
        <div class="value">${fmtTokens(t.tokensSold)}</div>
      </div>
      <div class="detail-info-item">
        <div class="label">Total Volume</div>
        <div class="value">${fmtSol(t.totalVolumeSol)} SOL</div>
      </div>
      <div class="detail-info-item">
        <div class="label">Creator Fee</div>
        <div class="value">${(t.creatorFeeBps / 100).toFixed(1)}%</div>
      </div>
      <div class="detail-info-item">
        <div class="label">Migration</div>
        <div class="value" style="color:${t.migrationPct > 80 ? 'var(--neon)' : 'var(--text2)'}">${t.migrationPct.toFixed(1)}%</div>
      </div>
      <div class="detail-info-item">
        <div class="label">Created</div>
        <div class="value" style="font-size:12px">${timeAgo(t.createdAt)}</div>
      </div>
    </div>

    <div style="margin-bottom:16px">
      <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Mint</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:12px;word-break:break-all;color:var(--text2)">
        ${t.mint}
        <a href="https://solscan.io/token/${t.mint}${net().solscanCluster}" target="_blank" style="color:var(--neon);margin-left:6px"><i class="fa-solid fa-external-link"></i></a>
      </div>
    </div>

    ${t.migrated ? '<div style="text-align:center;padding:16px;color:var(--purple);font-weight:700"><i class="fa-solid fa-water"></i> This token has graduated to AMM</div>' : `
    <div class="trade-tabs">
      <button class="trade-tab active-buy" id="tabBuy" onclick="setTradeMode('buy')">üíö Buy</button>
      <button class="trade-tab" id="tabSell" onclick="setTradeMode('sell')">üî¥ Sell</button>
    </div>

    <div id="tradePanel">
      <div class="trade-input-group">
        <input type="number" id="tradeAmount" placeholder="0.01" step="0.001" min="0">
        <span class="unit" id="tradeUnit">SOL</span>
      </div>
      <div class="quick-amounts" id="quickAmounts">
        <button class="quick-amt" onclick="setQuickAmt(0.01)">0.01</button>
        <button class="quick-amt" onclick="setQuickAmt(0.05)">0.05</button>
        <button class="quick-amt" onclick="setQuickAmt(0.1)">0.1</button>
        <button class="quick-amt" onclick="setQuickAmt(0.5)">0.5</button>
        <button class="quick-amt" onclick="setQuickAmt(1)">1.0</button>
      </div>
      <button class="trade-btn buy" id="tradeBtn" onclick="executeTrade()">üíö Buy</button>
    </div>
    `}

    <div class="tx-result" id="detailTxResult"></div>
  `;

  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('show');
  currentDetailToken = null;
}

function setTradeMode(mode) {
  tradeMode = mode;
  const buyTab = document.getElementById('tabBuy');
  const sellTab = document.getElementById('tabSell');
  const btn = document.getElementById('tradeBtn');
  const unit = document.getElementById('tradeUnit');
  const input = document.getElementById('tradeAmount');

  if (mode === 'buy') {
    buyTab.className = 'trade-tab active-buy';
    sellTab.className = 'trade-tab';
    btn.className = 'trade-btn buy';
    btn.innerHTML = 'üíö Buy';
    unit.textContent = 'SOL';
    input.placeholder = '0.01';
    input.step = '0.001';
    // Show SOL quick amounts
    document.getElementById('quickAmounts').innerHTML = `
      <button class="quick-amt" onclick="setQuickAmt(0.01)">0.01</button>
      <button class="quick-amt" onclick="setQuickAmt(0.05)">0.05</button>
      <button class="quick-amt" onclick="setQuickAmt(0.1)">0.1</button>
      <button class="quick-amt" onclick="setQuickAmt(0.5)">0.5</button>
      <button class="quick-amt" onclick="setQuickAmt(1)">1.0</button>
    `;
  } else {
    buyTab.className = 'trade-tab';
    sellTab.className = 'trade-tab active-sell';
    btn.className = 'trade-btn sell';
    btn.innerHTML = 'üî¥ Sell';
    unit.textContent = 'Tokens';
    input.placeholder = '1000000';
    input.step = '1000';
    document.getElementById('quickAmounts').innerHTML = `
      <button class="quick-amt" onclick="setQuickAmt(100000)">100K</button>
      <button class="quick-amt" onclick="setQuickAmt(1000000)">1M</button>
      <button class="quick-amt" onclick="setQuickAmt(5000000)">5M</button>
      <button class="quick-amt" onclick="setQuickAmt(10000000)">10M</button>
    `;
  }
  input.value = '';
}

function setQuickAmt(val) {
  document.getElementById('tradeAmount').value = val;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXECUTE TRADE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function executeTrade() {
  if (!walletPubkey) { toast('Connect wallet first'); return; }
  if (!currentDetailToken) return;

  const amount = parseFloat(document.getElementById('tradeAmount').value);
  if (!amount || amount <= 0) { toast('Enter a valid amount'); return; }

  const btn = document.getElementById('tradeBtn');
  btn.disabled = true;
  const origText = btn.innerHTML;

  if (tradeMode === 'buy') {
    btn.innerHTML = '<div class="spinner"></div> Buying...';
    await buyToken(currentDetailToken.mint, amount, btn, origText);
  } else {
    btn.innerHTML = '<div class="spinner"></div> Selling...';
    await sellToken(currentDetailToken.mint, Math.floor(amount * 1e6), btn, origText);
  }
}

async function buyToken(mintStr, solAmount, btn, origText) {
  const { PublicKey, Transaction, TransactionInstruction, SystemProgram } = solanaWeb3;
  const mint = new PublicKey(mintStr);

  try {
    const [platformConfig] = findPDA([SEEDS.platformConfig]);
    const [tokenLaunch] = findPDA([SEEDS.tokenLaunch, mint]);
    const [solVault] = findPDA([SEEDS.solVault, mint]);
    const [platformVault] = findPDA([SEEDS.platformVault]);
    const launchVault = getATA(mint, tokenLaunch);
    const buyerAta = getATA(mint, walletPubkey);
    const [userPosition] = findPDA([SEEDS.userPosition, walletPubkey, mint]);

    // Find creator from token data
    const t = allTokens.find(tk => tk.mint === mintStr);
    const creatorKey = t ? new PublicKey(t.creator) : walletPubkey;

    const tx = new Transaction();

    // Pre-fund PDAs if needed
    const rentExempt = await connection.getMinimumBalanceForRentExemption(0);
    const svInfo = await connection.getAccountInfo(solVault);
    const pvInfo = await connection.getAccountInfo(platformVault);
    if (!svInfo) tx.add(SystemProgram.transfer({ fromPubkey: walletPubkey, toPubkey: solVault, lamports: rentExempt }));
    if (!pvInfo) tx.add(SystemProgram.transfer({ fromPubkey: walletPubkey, toPubkey: platformVault, lamports: rentExempt }));

    const lamports = BigInt(Math.round(solAmount * 1e9));
    const disc = await getDiscriminator('buy');
    const data = new Uint8Array(16);
    data.set(disc, 0);
    new DataView(data.buffer).setBigUint64(8, lamports, true);

    tx.add(new TransactionInstruction({
      keys: [
        { pubkey: tokenLaunch, isSigner: false, isWritable: true },
        { pubkey: mint, isSigner: false, isWritable: false },
        { pubkey: launchVault, isSigner: false, isWritable: true },
        { pubkey: solVault, isSigner: false, isWritable: true },
        { pubkey: buyerAta, isSigner: false, isWritable: true },
        { pubkey: userPosition, isSigner: false, isWritable: true },
        { pubkey: platformVault, isSigner: false, isWritable: true },
        { pubkey: creatorKey, isSigner: false, isWritable: true },
        { pubkey: platformConfig, isSigner: false, isWritable: true },
        { pubkey: walletPubkey, isSigner: true, isWritable: true },
        { pubkey: TOKEN_PROGRAM, isSigner: false, isWritable: false },
        { pubkey: ATA_PROGRAM, isSigner: false, isWritable: false },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
      ],
      programId: PROGRAM_KEY,
      data,
    }));

    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
    tx.feePayer = walletPubkey;
    const sig = await signAndSend(tx);
    await connection.confirmTransaction(sig, 'confirmed');

    toast('üíö Buy succeeded!');
    showDetailTx('buy', sig, mintStr);
    updateBalance();
    loadLiveTokens();
  } catch (e) {
    console.error('Buy failed:', e);
    toast('‚ùå Buy failed: ' + (e.message || e));
  } finally {
    btn.disabled = false;
    btn.innerHTML = origText;
  }
}

async function sellToken(mintStr, tokenAmount, btn, origText) {
  const { PublicKey, Transaction, TransactionInstruction, SystemProgram } = solanaWeb3;
  const mint = new PublicKey(mintStr);

  try {
    const [platformConfig] = findPDA([SEEDS.platformConfig]);
    const [tokenLaunch] = findPDA([SEEDS.tokenLaunch, mint]);
    const [solVault] = findPDA([SEEDS.solVault, mint]);
    const [platformVault] = findPDA([SEEDS.platformVault]);
    const launchVault = getATA(mint, tokenLaunch);
    const sellerAta = getATA(mint, walletPubkey);
    const [userPosition] = findPDA([SEEDS.userPosition, walletPubkey, mint]);

    const t = allTokens.find(tk => tk.mint === mintStr);
    const creatorKey = t ? new PublicKey(t.creator) : walletPubkey;

    const disc = await getDiscriminator('sell');
    const data = new Uint8Array(16);
    data.set(disc, 0);
    new DataView(data.buffer).setBigUint64(8, BigInt(tokenAmount), true);

    const tx = new Transaction().add(new TransactionInstruction({
      keys: [
        { pubkey: tokenLaunch, isSigner: false, isWritable: true },
        { pubkey: mint, isSigner: false, isWritable: false },
        { pubkey: launchVault, isSigner: false, isWritable: true },
        { pubkey: solVault, isSigner: false, isWritable: true },
        { pubkey: sellerAta, isSigner: false, isWritable: true },
        { pubkey: userPosition, isSigner: false, isWritable: true },
        { pubkey: platformVault, isSigner: false, isWritable: true },
        { pubkey: creatorKey, isSigner: false, isWritable: true },
        { pubkey: platformConfig, isSigner: false, isWritable: true },
        { pubkey: walletPubkey, isSigner: true, isWritable: true },
        { pubkey: TOKEN_PROGRAM, isSigner: false, isWritable: false },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
      ],
      programId: PROGRAM_KEY,
      data,
    }));

    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
    tx.feePayer = walletPubkey;
    const sig = await signAndSend(tx);
    await connection.confirmTransaction(sig, 'confirmed');

    toast('üî¥ Sell succeeded!');
    showDetailTx('sell', sig, mintStr);
    updateBalance();
    loadLiveTokens();
  } catch (e) {
    console.error('Sell failed:', e);
    toast('‚ùå Sell failed: ' + (e.message || e));
  } finally {
    btn.disabled = false;
    btn.innerHTML = origText;
  }
}

function showDetailTx(action, sig, mint) {
  const el = document.getElementById('detailTxResult');
  if (!el) return;
  const emoji = action === 'buy' ? 'üíö' : action === 'sell' ? 'üî¥' : 'üöÄ';
  el.innerHTML = `
    <div style="font-weight:700;margin-bottom:4px">${emoji} ${action.charAt(0).toUpperCase() + action.slice(1)} Confirmed!</div>
    <div style="font-size:12px">Tx: <a href="https://solscan.io/tx/${sig}${net().solscanCluster}" target="_blank">${sig.slice(0,24)}...</a></div>
  `;
  el.classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATE TOKEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function createToken() {
  if (!walletPubkey) { toast('Connect wallet first'); return; }

  const { PublicKey, Transaction, TransactionInstruction, SystemProgram, Keypair, SYSVAR_RENT_PUBKEY } = solanaWeb3;

  const name = document.getElementById('tokenName')?.value?.trim();
  const symbol = document.getElementById('tokenSymbol')?.value?.trim().toUpperCase();
  if (!name) { toast('Enter a token name'); return; }
  if (!symbol) { toast('Enter a symbol'); return; }

  const description = document.getElementById('tokenDesc')?.value?.trim() || '';
  let uri = document.getElementById('tokenUri')?.value?.trim() || '';
  const feePct = parseFloat(document.getElementById('creatorFee')?.value || '5');
  const feeBps = Math.round(feePct * 100); // 5% = 500 bps

  const launchBtn = document.getElementById('launchBtn');
  launchBtn.disabled = true;
  launchBtn.textContent = '‚è≥ Creating...';

  // ‚îÄ‚îÄ‚îÄ Storacha Upload ‚îÄ‚îÄ‚îÄ
  const storachaEnabled = document.getElementById('storachaToggle')?.checked;
  if (storachaEnabled && !uri && typeof uploadTokenMetadataToStoracha === 'function') {
    try {
      launchBtn.textContent = 'üì¶ Uploading to Filecoin...';
      const result = await uploadTokenMetadataToStoracha({
        name, symbol, description,
        imageFile: selectedImageFile,
        creatorAddress: walletPubkey.toBase58(),
      });
      if (result?.metadataUri) {
        uri = result.metadataUri;
        toast('‚úÖ Metadata stored on Filecoin!');
      }
    } catch (e) {
      console.warn('Storacha upload failed:', e);
    }
  }
  if (!uri) uri = 'https://senditsolana.io';

  launchBtn.textContent = '‚è≥ Sending transaction...';

  try {
    const mintKeypair = Keypair.generate();
    const mint = mintKeypair.publicKey;
    const [platformConfig] = findPDA([SEEDS.platformConfig]);
    const [tokenLaunch] = findPDA([SEEDS.tokenLaunch, mint]);
    const [solVault] = findPDA([SEEDS.solVault, mint]);
    const launchVault = getATA(mint, tokenLaunch);

    // Metaplex metadata PDA
    const [metadata] = PublicKey.findProgramAddressSync(
      [new TextEncoder().encode('metadata'), MPL_METADATA.toBuffer(), mint.toBuffer()],
      MPL_METADATA
    );

    const disc = await getDiscriminator('create_token');
    const feeBuf = new Uint8Array(2);
    new DataView(feeBuf.buffer).setUint16(0, feeBps, true);
    const data = concat(disc, encodeString(name), encodeString(symbol), encodeString(uri), feeBuf);

    const ix = new TransactionInstruction({
      keys: [
        { pubkey: tokenLaunch, isSigner: false, isWritable: true },
        { pubkey: mint, isSigner: true, isWritable: true },
        { pubkey: launchVault, isSigner: false, isWritable: true },
        { pubkey: solVault, isSigner: false, isWritable: true },
        { pubkey: metadata, isSigner: false, isWritable: true },
        { pubkey: platformConfig, isSigner: false, isWritable: true },
        { pubkey: walletPubkey, isSigner: true, isWritable: true },
        { pubkey: TOKEN_PROGRAM, isSigner: false, isWritable: false },
        { pubkey: ATA_PROGRAM, isSigner: false, isWritable: false },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
        { pubkey: SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
        { pubkey: MPL_METADATA, isSigner: false, isWritable: false },
      ],
      programId: PROGRAM_KEY,
      data,
    });

    const tx = new Transaction().add(ix);
    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
    tx.feePayer = walletPubkey;
    tx.partialSign(mintKeypair);

    const sig = await signAndSend(tx);
    await connection.confirmTransaction(sig, 'confirmed');

    toast(`üöÄ Token launched! ${name} ($${symbol})`);

    // Show result
    const el = document.getElementById('createTxResult');
    el.innerHTML = `
      <div style="font-weight:700;margin-bottom:8px">üöÄ Token Created!</div>
      <div style="font-size:12px;margin-bottom:4px">Name: <strong>${escHtml(name)}</strong> ($${escHtml(symbol)})</div>
      <div style="font-size:12px;margin-bottom:4px">Mint: <span style="font-family:'JetBrains Mono',monospace">${mint.toBase58()}</span></div>
      <div style="font-size:12px">Tx: <a href="https://solscan.io/tx/${sig}${net().solscanCluster}" target="_blank">${sig.slice(0,24)}...</a></div>
    `;
    el.classList.add('show');

    // Post to Tapestry
    try {
      await fetch(`${TAPESTRY_API}/contents/create?apiKey=${TAPESTRY_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          profileId: walletPubkey.toBase58().slice(0, 8),
          content: `üöÄ Launched ${name} ($${symbol}) on Send.it!\nMint: ${mint.toBase58()}`,
          contentType: 'text',
          customProperties: [
            { key: 'type', value: 'token_launch' },
            { key: 'mint', value: mint.toBase58() },
          ],
          blockchain: 'SOLANA',
          execution: 'FAST_UNCONFIRMED'
        })
      });
    } catch (e) { console.warn('Tapestry post failed:', e); }

    // Clear form
    document.getElementById('tokenName').value = '';
    document.getElementById('tokenSymbol').value = '';
    document.getElementById('tokenDesc').value = '';
    document.getElementById('tokenUri').value = '';

    updateBalance();
    loadLiveTokens();
  } catch (e) {
    console.error('Create failed:', e);
    toast('‚ùå Launch failed: ' + (e.message || e));
  } finally {
    launchBtn.disabled = false;
    launchBtn.textContent = 'üöÄ Launch Token';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PORTFOLIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPortfolio() {
  const container = document.getElementById('portfolioContent');
  if (!walletPubkey) {
    container.innerHTML = `<div class="portfolio-empty"><i class="fa-solid fa-wallet"></i><p style="font-size:16px;font-weight:600;margin-bottom:8px">Connect your wallet</p><p>Your token positions will appear here</p></div>`;
    return;
  }

  container.innerHTML = '<div class="loading-grid"><div class="spinner"></div><p style="margin-top:12px">Loading positions...</p></div>';

  try {
    // Find all token accounts owned by the wallet
    const tokenAccounts = await connection.getParsedTokenAccountsByOwner(walletPubkey, { programId: TOKEN_PROGRAM });

    const positions = [];
    for (const ta of tokenAccounts.value) {
      const info = ta.account.data.parsed.info;
      const mintStr = info.mint;
      const amount = info.tokenAmount;
      if (amount.uiAmount === 0) continue;

      // Check if this mint matches any of our launched tokens
      const token = allTokens.find(t => t.mint === mintStr);

      positions.push({
        mint: mintStr,
        balance: amount.uiAmount,
        balanceRaw: amount.amount,
        decimals: amount.decimals,
        name: token?.name || 'Unknown Token',
        symbol: token?.symbol || mintStr.slice(0, 6) + '...',
        isOurs: !!token,
        token,
      });
    }

    // Sort: our tokens first
    positions.sort((a, b) => (b.isOurs ? 1 : 0) - (a.isOurs ? 1 : 0));

    if (positions.length === 0) {
      container.innerHTML = `<div class="portfolio-empty"><i class="fa-solid fa-box-open"></i><p style="font-size:16px;font-weight:600;margin-bottom:8px">No tokens yet</p><p>Buy some tokens or launch your own!</p></div>`;
      return;
    }

    container.innerHTML = positions.map(p => `
      <div class="card position-card" ${p.isOurs ? `style="cursor:pointer" onclick="openDetail('${p.mint}')"` : ''}>
        <div class="token-img">${p.isOurs ? 'ü™ô' : 'üíé'}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escHtml(p.name)} <span style="font-family:'JetBrains Mono',monospace;color:var(--neon);font-size:12px">$${escHtml(p.symbol)}</span></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text2);margin-top:2px">${p.balance.toLocaleString()} tokens</div>
        </div>
        ${p.isOurs ? '<div style="color:var(--neon);font-size:12px;font-weight:600">Send.it ‚úì</div>' : ''}
      </div>
    `).join('');
  } catch (e) {
    console.error('Portfolio load failed:', e);
    container.innerHTML = `<div class="portfolio-empty"><p>Failed to load portfolio</p><p style="font-size:12px;color:var(--text3)">${e.message}</p></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMAGE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initImageUpload() {
  const area = document.getElementById('uploadArea');
  if (!area) return;

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/png,image/jpeg,image/gif,image/webp';
  fileInput.style.display = 'none';
  area.appendChild(fileInput);

  area.addEventListener('click', () => fileInput.click());

  area.addEventListener('dragover', (e) => {
    e.preventDefault();
    area.style.borderColor = 'var(--neon)';
    area.style.background = 'rgba(0,232,123,.06)';
  });
  area.addEventListener('dragleave', () => {
    area.style.borderColor = '';
    area.style.background = '';
  });
  area.addEventListener('drop', (e) => {
    e.preventDefault();
    area.style.borderColor = '';
    area.style.background = '';
    const file = e.dataTransfer.files[0];
    if (file?.type.startsWith('image/')) handleImage(file);
  });
  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) handleImage(fileInput.files[0]);
  });
}

function handleImage(file) {
  if (file.size > 5 * 1024 * 1024) { toast('Image too large (max 5MB)'); return; }
  selectedImageFile = file;
  const area = document.getElementById('uploadArea');
  const reader = new FileReader();
  reader.onload = (e) => {
    area.innerHTML = `
      <img src="${e.target.result}" style="max-height:120px;border-radius:8px;margin-bottom:8px">
      <div style="color:var(--neon);font-weight:600">${file.name}</div>
      <div style="font-size:11px;color:var(--text2);margin-top:4px">${(file.size / 1024).toFixed(1)} KB ¬∑ Click to change</div>
    `;
  };
  reader.readAsDataURL(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ‚îÄ‚îÄ‚îÄ Keyboard shortcut: Escape to close detail ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeDetail();
});
</script>
</body>
</html>
